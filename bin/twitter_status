#!/usr/bin/env perl

# Show the recent twitter postings by the given user
# https://github.com/bocchilorenzo/ntscraper

use strict;
use warnings;
use autodie qw(:all);
# use Data::Dumper;
use File::HomeDir;
use JSON::MaybeXS;

die "Usage: $0 account" unless($ARGV[0]);

my $home = File::HomeDir->my_home();
open(my $fin, '-|', "python3 $home/src/njh/NJH-Snippets/bin/twitter_status.py $ARGV[0] 2> /dev/null");
# open(my $fin, '-|', "python3 $home/src/njh/NJH-Snippets/bin/twitter_status.py $ARGV[0]");
if($fin) {
	my $data;

	while(my $line = <$fin>) {
		if($line =~ /Fetching error: Instance has been rate limited.Use another instance or try again later./) {
			# This close fails
			# close $fin;
			die 'Try again';
		}
		next if($line =~ /Empty page on/);
		print $line;
		chomp $line;
		$data .= $line;
	}
	# This fails some times
	# close $fin;

	# Fix the JSON
	$data =~ s/"/\\"/g;
	$data =~ s/'is-retweet': False, /"is-retweet": "False", /g;
	$data =~ s/'is-retweet': True, /"is-retweet": "True", /g;
	$data =~ tr/'/"/;

	# print "$data\n\n\n";

	my @tweets = @{JSON::MaybeXS->new()->utf8()->decode($data)->{'tweets'}};

	# print Data::Dumper->new([\@tweets])->Dump();
	foreach my $tweet(@tweets) {
		next if($tweet->{'is-retweet'} eq 'True');
		# $tweet->{'text'} =~ s/#m$//;
		print $tweet->{'link'}, ': ', $tweet->{'text'}, "\n";
	}
} else {
	die "./bbportal.py: $!";
}
