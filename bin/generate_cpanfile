#!/usr/bin/env perl

use strict;
use warnings;
use File::Slurp qw(read_file);

my $file = shift || 'Makefile.PL';
die "Cannot read $file\n" unless -r $file;

my $content = read_file($file);

my %deps;
my $min_perl;

# ----------------------------
# Extraction phase
# ----------------------------

if ($content =~ /MIN_PERL_VERSION\s*=>\s*(['"]?)([\d._]+)\1/) {
    $min_perl = $2;
}

my %map = (
    PREREQ_PM          => 'runtime',
    BUILD_REQUIRES     => 'build',
    TEST_REQUIRES      => 'test',
    CONFIGURE_REQUIRES => 'configure',
);

for my $mf_key (keys %map) {
    if ($content =~ /$mf_key\s*=>\s*\{(.*?)\}/s) {
        my $block = $1;

        while ($block =~ /
            ['"]([^'"]+)['"]
            \s*=>\s*
            ['"]?([\d._]+)?['"]?
        /gx) {
            my ($mod, $ver) = ($1, $2 // 0);
            $deps{ $map{$mf_key} }{$mod} = $ver;
        }
    }
}

# ----------------------------
# Post-processing hook
# ----------------------------

post_process_deps(\%deps);

sub post_process_deps {
    my ($deps) = @_;

    # Author / development-only dependencies
    $deps->{develop} ||= {};

    my %author_tools = (
        'Perl::Critic'         => 0,
        'Devel::Cover'         => 0,
        'Test::Pod'            => 0,
        'Test::Pod::Coverage'  => 0,
    );

    for my $module (keys %author_tools) {
        $deps->{develop}{$module} //= $author_tools{$module};
    }
}

# ----------------------------
# Emit cpanfile
# ----------------------------

print "# Generated from Makefile.PL\n\n";

print "perl '$min_perl';\n\n" if $min_perl;

if (my $runtime = $deps{runtime}) {
    for my $module (sort keys %$runtime) {
        my $ver = $runtime->{$module};
        print "requires '$module'";
        print ", '$ver'" if $ver && $ver ne '0';
        print ";\n";
    }
    print "\n";
}

for my $phase (qw(configure build test develop)) {
    my $list = $deps{$phase} or next;

    print "on '$phase' => sub {\n";
    for my $module (sort keys %$list) {
        my $ver = $list->{$module};
        print "    requires '$module'";
        print ", '$ver'" if $ver && $ver ne '0';
        print ";\n";
    }
    print "};\n\n";
}
