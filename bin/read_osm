#!/usr/bin/env perl

# Print towns and cities latitutes a longitudes from an OSM file
# e.g. https://download.geofabrik.de/europe-latest.osm.bz2

# TODO, print places in the towns

use strict;
use warnings;
use autodie qw(:all);

no lib '.';

my @needfull;

# Install Pre-requisites
BEGIN {
	my @modules = (
		'XML::LibXML::Reader'
	);

	foreach my $module(@modules) {
		eval "use $module";
		if($@) {
			push @needfull, $module;
		}
	}

	if(scalar(@needfull)) {
		my $list = join(' ', @needfull);
		print "Installing $list\n";
		system("cpan -i $list");
	}

	# FIXME
	$SIG{__WARN__} = sub {
		my $warning = shift;
		if($warning =~ /^Use of uninitialized value/) {
			die $warning;
		}
		warn $warning;
	};
}

foreach my $module(@needfull) {
	my $version;
	if($module =~ /(.+)\s(.+)$/) {
		$module = $1;
		$version = $2;
	}
	if($module =~ /.+\/(.+)/) {
		$module = $1;
	}
	eval "require $module";
	if($@) {
		die $@;
	}
	$module->import();
	# if($version && ($module::VERSION < $version)) {
		# die "$module: need $version got ", $module::VERSION;
	# }
}

binmode(STDOUT, "encoding(UTF-8)");

open(my $pin, '-|', 'bzcat ../../../../Downloads/europe-latest.osm.bz2');
my $reader = XML::LibXML::Reader->new(FD => $pin)
	or die "cannot read file.xml\n";

my $in_node;
my $node;
my $key;
my $name;
my $is_in;
my $lat;
my $lon;

while($reader->read()) {
	processNode($reader);
}

sub processNode {
	my $reader = shift;
	# printf "%d %d %s %d %d\n", ($reader->depth,
		      # $reader->nodeType,
		      # $reader->name,
		      # # $reader->isEmptyElement);
		      # $reader->attributeCount(),
		      # $reader->hasValue);

	# These constants are not exported by default :-(
	if($reader->nodeType() == 1) {
		$node = $reader->name();
		if($node eq 'node') {
			if($reader->hasAttributes()) {
				$lat = $reader->getAttribute('lat');
				$lon = $reader->getAttribute('lon');
				$in_node = 1;
			}
		} elsif($in_node) {
			if($node eq 'tag') {
				if($reader->hasAttributes()) {
					my $key = $reader->getAttribute('k');
					# print "$key\n";
					if($key eq 'name:en') {
						$name = $reader->getAttribute('v');
						# print "$name\n";
					} elsif($key eq 'is_in') {
						$is_in = $reader->getAttribute('v');
					}
				}
			}
		}
	} elsif($reader->nodeType() == 15) {
		if(defined($name) && defined($is_in) && defined($lat) && defined($lon)) {
			$is_in =~ s/,(\w)/, $1/g;
			$is_in =~ s/, United Kingdom/, UK/;
			$is_in =~ s/, UK,.+$/, UK/;
			$is_in =~ s/(England|Scotland|Wales), UK/$1/;
			print "$name, $is_in: $lat, $lon\n";
			$key = undef;
			$node = undef;
			$name = undef;
			$lat = undef;
			$lon = undef;
			$is_in = undef;
			$in_node = 0;
		}
	}
}
