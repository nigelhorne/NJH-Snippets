#!/usr/bin/env perl

# Use Geo::Coder::Free to see if the locations in a gedcom are known
# Needs to be run in the same directory as the gedcom program resides

use warnings;
use strict;
use autodie qw(:all);

use Geo::Coder::Free;
use Geo::Coder::Free::Local;

die "Usage: $0 gedcom-file" unless($ARGV[0]);
die 'Set OPENADDR_HOME to enable testing' unless($ENV{'OPENADDR_HOME'});

my $l = Geo::Coder::Free::Local->new();
# my $g = Geo::Coder::Free::OpenAddresses->new(openaddr => $ENV{'OPENADDR_HOME'});
my $g = Geo::Coder::Free->new(openaddr => $ENV{'OPENADDR_HOME'});

open(my $fin, '-|', "./gedcom -T \"$ARGV[0]\"");

while(my $line = <$fin>) {
	next if($line =~ /\d%/);

	my ($place, $people) = split(/:\s/, $line);
	next unless($people);
	$people =~ s/[\r\n]//;

	run($place, $people);
}

sub run {
	my ($place, $people) = @_;

	return unless($place =~ /(Canada|US|USA|United States|Australia|England)$/i);

	eval {
		if(my $rc = $l->geocode($place)) {
			# print "$place: ", $rc->lat(), '/', $rc->long(), "\n";
		} elsif($rc = $g->geocode($place)) {
			# print "$place: ", $rc->lat(), '/', $rc->long(), "\n";
		} else {
			print "$place failed\n\t$people\n";
		}
	};
	if($@) {
		print "$place: $@";
	}
}
