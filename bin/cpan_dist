#!/usr/bin/env perl

use strict;
use warnings;

use HTTP::Tiny;
use JSON::MaybeXS;
use URI::Escape qw(uri_escape);
use version;

my $dist_name = $ARGV[0];	# Hyphen not colons
my $cpan_api = 'https://api.cpantesters.org/v3/summary/' . uri_escape($dist_name);

my $http = HTTP::Tiny->new(agent => 'cpan-coverage-html/1.0', timeout => 15);

my $res = $http->get($cpan_api);

my $version;

if ($res->{success}) {
	my $releases = eval { decode_json($res->{content}) };
	foreach my $release(@{$releases}) {
		if(!defined($version)) {
			$version = $release->{version};
		} elsif(version->parse($release->{version}) > version->parse($version)) {
			$version = $release->{version};
		}
	}

	print "CPAN Release: $version\n";
} else {
	print "$cpan_api: $res->{status} $res->{reason}\n";
}
